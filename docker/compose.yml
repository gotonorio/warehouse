# 通帳監査システム
services:
  warehouse:
    # 相対パスでDockerfileのpathを指定。contextは一つ上の階層にする。
    build:
      context: ..
      dockerfile: docker/Dockerfile
    # image名:タグ
    image: warehouse
    # 起動ユーザを指定する
    user: "${UID}:${GID}"
    # container名
    container_name: warehouse
    restart: unless-stopped

    # ここで指定した中身が、OSの環境変数としてDjangoに渡される（settings.py
    env_file:
      - ../.env

    # ディレクトリ全体をマウントしない方が良いようだ。
    # ホスト上のcollectstaticで作成されたstaticディレクトリを/code/staticとしてマウントする。
    # （settings.pyで STATIC_ROOT = "/code/static"としている）
    # （/codeはDockerfileでWORKDIRとしている）
    # ホスト上のwh2.sqlite3、media/を/code/にマウントする。
    volumes:
      - ../static:/code/static
      - ../wh2.sqlite3:/code/wh2.sqlite3
      - ../media:/code/media
      - /home/sophiag_master/bulma/opt/shared_data/parking_maps:/code/inputs/parking_maps:ro,z
      - /home/sophiag_master/bulma/opt/shared_data/balance_sheets:/code/inputs/balance_sheets:ro,z

    # # ホスト上のcalendar/ディレクトリをcode/としてコンテナにマウントする。
    # volumes:
    #   - ../:/code

    # 環境変数TZを設定。
    environment:
      TZ: "Asia/Tokyo"
      APP_ENV: "product"

    # 本番環境で、コンテナネットワークだけにポートを公開する場合はexposeするだけ。
    expose:
      - "8100"
    command: /usr/local/bin/gunicorn warehouse.wsgi:application --workers 1 --threads 4 --bind :8100

    # コンテナを外部ネットワークに接続する。
    networks:
      - sophiag-network

networks:
  sophiag-network:
    external: true
